{% extends "base.html" %}

{% block title %}Group Delivery Lead Dashboard - MyISP{% endblock %}

{% block user_name %}{{ gdl_name }} (Group Delivery Lead){% endblock %}

{% block nav %}
<nav class="global-nav">
    <a href="{{ url_for('group_delivery_lead_dashboard', gdl=gdl_name) }}" class="active">Global Overview</a>
    <a href="{{ url_for('group_delivery_lead_reports') }}">Reports</a>
    <a href="{{ url_for('group_delivery_lead_import_data') }}">Data Import</a>
    <a href="{{ url_for('group_delivery_lead_settings') }}">Settings</a>
</nav>
{% endblock %}

{% block extra_css %}
{% endblock %}

{% block content %}
<div class="main-container">
    <h1 class="page-title">Group Delivery Lead Dashboard: {{ gdl_name }}</h1>

    <!-- KPI Cards -->
    <div class="kpi-row">
        <div class="kpi-card">
            <span class="kpi-value">{{ dhs|length }}</span>
            <span class="kpi-label">Delivery Heads</span>
        </div>
        <div class="kpi-card">
            <span class="kpi-value">
                {% set total_dls = namespace(count=0) %}
                {% for dh in dhs %}
                    {% set total_dls.count = total_dls.count + dh.dls|length %}
                {% endfor %}
                {{ total_dls.count }}
            </span>
            <span class="kpi-label">Delivery Leads</span>
        </div>
        <div class="kpi-card">
            <span class="kpi-value">
                {% set total_managers = namespace(count=0) %}
                {% for dh in dhs %}
                    {% for dl in dh.dls %}
                        {% set total_managers.count = total_managers.count + dl.managers|length %}
                    {% endfor %}
                {% endfor %}
                {{ total_managers.count }}
            </span>
            <span class="kpi-label">Managers</span>
        </div>
        <div class="kpi-card">
             <span class="kpi-value">
                {% set total_workforce = namespace(count=0) %}
                {% for dh in dhs %}
                    {% for dl in dh.dls %}
                        {% for mgr in dl.managers %}
                             {% set total_workforce.count = total_workforce.count + mgr.employees|length %}
                        {% endfor %}
                    {% endfor %}
                {% endfor %}
                {{ total_workforce.count }}
            </span>
            <span class="kpi-label">Total Workforce</span>
        </div>
        <div class="kpi-card alert">
            <span class="kpi-value">60%</span>
            <span class="kpi-label">Enterprise Gaps</span>
        </div>
    </div>

    <!-- Search & Filter Card -->
    <div class="search-card">
        <div class="search-card-header">
            <svg class="search-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
            <h3 class="search-card-title">Search & Filter Global Enterprise</h3>
        </div>

        <div class="filter-grid">
            <div class="filter-field">
                <label class="filter-label">Delivery Head</label>
                <select id="dh-filter" class="filter-select">
                    <option value="">All Delivery Heads</option>
                    {% for dh in dhs %}
                    <option value="{{ dh.name }}">{{ dh.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="filter-field">
                <label class="filter-label">Delivery Lead</label>
                <select id="dl-filter" class="filter-select">
                    <option value="">All Delivery Leads</option>
                    {% for dh in dhs %}
                        {% for dl in dh.dls %}
                        <option value="{{ dl.name }}">{{ dl.name }}</option>
                        {% endfor %}
                    {% endfor %}
                </select>
            </div>

            <div class="filter-field">
                <label class="filter-label">Manager</label>
                <select id="manager-filter" class="filter-select">
                    <option value="">All Managers</option>
                    {% for dh in dhs %}
                        {% for dl in dh.dls %}
                            {% for mgr in dl.managers %}
                            <option value="{{ mgr.name }}">{{ mgr.name }}</option>
                            {% endfor %}
                        {% endfor %}
                    {% endfor %}
                </select>
            </div>

            <div class="filter-field">
                <label class="filter-label">Employee</label>
                <select id="employee-filter" class="filter-select">
                    <option value="">All Employees</option>
                    {% for dh in dhs %}
                        {% for dl in dh.dls %}
                            {% for mgr in dl.managers %}
                                {% for emp in mgr.employees %}
                                <option value="{{ emp.nbk }}">{{ emp.name }}</option>
                                {% endfor %}
                            {% endfor %}
                        {% endfor %}
                    {% endfor %}
                </select>
            </div>

            <div class="filter-field">
                <label class="filter-label">Search</label>
                <input type="text" id="search-input" class="filter-input" placeholder="Search...">
            </div>
        </div>

        <div>
            <button class="btn-clear" onclick="clearFilters()">Clear Filters</button>
        </div>
    </div>

    <!-- Delivery Head Sections -->
    {% for dh in dhs %}
    <div class="dh-section" data-dh="{{ dh.name }}">
        <div class="dh-header" onclick="toggleDH('dh-{{ loop.index }}')">
            <div class="dh-name">{{ dh.name }}</div>
            <span class="expand-icon" id="icon-dh-{{ loop.index }}">â–¶</span>
        </div>
        <div class="dh-content" id="content-dh-{{ loop.index }}">
            {% for dl in dh.dls %}
            <div class="dl-card" data-dl="{{ dl.name }}">
                <div class="dl-card-header">{{ dl.name }}</div>

                {% for manager in dl.managers %}
                <div class="manager-card clean-white" data-manager="{{ manager.name }}">
                    <div class="manager-card-header">{{ manager.name }} ({{ manager.employees|length }} employees)</div>

                    <table class="team-table">
                        <thead>
                            <tr>
                                <th>Employee</th>
                                <th>Role</th>
                                <th>Function</th>
                                <th class="text-center">Skills</th>
                                <th>Current</th>
                                <th>Future</th>
                                <th class="w-action-col">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for emp in manager.employees %}
                            <tr data-nbk="{{ emp.nbk }}">
                                <td>
                                    <strong>{{ emp.name }}</strong>
                                    <div class="text-small-muted">{{ emp.nbk }}</div>
                                </td>
                                <td>{{ emp.role }}</td>
                                <td>{{ emp.function }}</td>
                                <td class="text-center">{{ emp.total_skills }}</td>
                                <td>
                                    {% if emp.current_gaps == 0 %}
                                    <span class="status-indicator status-ok">OK</span>
                                    {% else %}
                                    <span class="status-indicator status-warn">{{ emp.current_gaps }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if emp.future_gaps == 0 %}
                                    <span class="status-indicator status-ok">OK</span>
                                    {% else %}
                                    <span class="status-indicator status-warn">{{ emp.future_gaps }}</span>
                                    {% endif %}
                                </td>
                                <td><a href="{{ url_for('group_delivery_lead_employee_details', nbk=emp.nbk) }}" class="btn btn-secondary" style="padding: 4px 8px; font-size: 11px;">View</a></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% endfor %}
            </div>
            {% endfor %}
        </div>
    </div>
    {% endfor %}

</div>
{% endblock %}

{% block extra_js %}
<script>
    function toggleDH(dhId) {
        const content = document.getElementById(`content-${dhId}`);
        const icon = document.getElementById(`icon-${dhId}`);
        content.classList.toggle('expanded');
        icon.classList.toggle('expanded');
    }

    const dhFilter = document.getElementById('dh-filter');
    const dlFilter = document.getElementById('dl-filter');
    const managerFilter = document.getElementById('manager-filter');
    const employeeFilter = document.getElementById('employee-filter');
    const searchInput = document.getElementById('search-input');

    function applyFilters() {
        const dhSelected = dhFilter.value;
        const dlSelected = dlFilter.value;
        const managerSelected = managerFilter.value;
        const employeeSelected = employeeFilter.value;
        const searchTerm = searchInput.value.toLowerCase();

        document.querySelectorAll('.dh-section').forEach(dhSection => {
            const dhName = dhSection.getAttribute('data-dh');
            let showDH = true;

            if (dhSelected && dhName !== dhSelected) {
                showDH = false;
            }

            let visibleDLs = 0;
            dhSection.querySelectorAll('.dl-card').forEach(dlCard => {
                const dlName = dlCard.getAttribute('data-dl');
                let showDL = true;

                if (dlSelected && dlName !== dlSelected) {
                    showDL = false;
                }

                let visibleManagers = 0;
                dlCard.querySelectorAll('.manager-card').forEach(mgrCard => {
                    const mgrName = mgrCard.getAttribute('data-manager');
                    let showManager = true;

                    if (managerSelected && mgrName !== managerSelected) {
                        showManager = false;
                    }

                    let visibleEmployees = 0;
                    mgrCard.querySelectorAll('tbody tr').forEach(empRow => {
                        const empNbk = empRow.getAttribute('data-nbk');
                        const empText = empRow.textContent.toLowerCase();
                        let showEmployee = true;

                        if (employeeSelected && empNbk !== employeeSelected) {
                            showEmployee = false;
                        }

                        if (searchTerm && !empText.includes(searchTerm)) {
                            showEmployee = false;
                        }

                        empRow.style.display = showEmployee ? '' : 'none';
                        if (showEmployee) visibleEmployees++;
                    });

                    if (visibleEmployees === 0 || !showManager) {
                        mgrCard.style.display = 'none';
                    } else {
                        mgrCard.style.display = '';
                        visibleManagers++;
                    }
                });

                if (visibleManagers === 0 || !showDL) {
                    dlCard.style.display = 'none';
                } else {
                    dlCard.style.display = '';
                    visibleDLs++;
                }
            });

            if (!showDH || visibleDLs === 0) {
                dhSection.style.display = 'none';
            } else {
                dhSection.style.display = '';

                if (dhSelected || dlSelected || managerSelected || employeeSelected || searchTerm) {
                    const content = dhSection.querySelector('.dh-content');
                    const icon = dhSection.querySelector('.expand-icon');
                    if (content && !content.classList.contains('expanded')) {
                        content.classList.add('expanded');
                        icon.classList.add('expanded');
                    }
                }
            }
        });
    }

    function clearFilters() {
        dhFilter.value = '';
        dlFilter.value = '';
        managerFilter.value = '';
        employeeFilter.value = '';
        searchInput.value = '';
        applyFilters();

        document.querySelectorAll('.dh-content').forEach(c => c.classList.remove('expanded'));
        document.querySelectorAll('.expand-icon').forEach(i => i.classList.remove('expanded'));
    }

    dhFilter.addEventListener('change', applyFilters);
    dlFilter.addEventListener('change', applyFilters);
    managerFilter.addEventListener('change', applyFilters);
    employeeFilter.addEventListener('change', applyFilters);
    searchInput.addEventListener('keyup', applyFilters);
</script>
{% endblock %}
